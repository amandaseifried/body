<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d9488">
<title>Body</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’ª</text></svg>">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --accent: #0d9488;
    --accent-light: #2dd4bf;
    --accent-glow: rgba(13, 148, 136, 0.25);
    --green: #22c55e;
    --green-dark: #16a34a;
    --yellow: #eab308;
    --red: #ef4444;
    --red-dark: #dc2626;
    --bg: #f0fdfa;
    --card: #ffffff;
    --text: #134e4a;
    --text-secondary: #5f7a78;
    --border: #d1ece8;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  html, body { height: 100%; overscroll-behavior: none; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  header {
    position: sticky; top: 0; z-index: 10;
    background: linear-gradient(135deg, #0d9488 0%, #2dd4bf 50%, #5eead4 100%);
    padding: 20px 20px 0;
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
    color: white;
  }

  .header-inner { display: flex; align-items: center; gap: 10px; }
  header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }

  .header-bottom {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 4px; padding-bottom: 12px;
  }

  .header-tagline { font-size: 13px; opacity: 0.85; font-weight: 400; }

  .sync-indicator { font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 8px; opacity: 0.9; }
  .sync-indicator.syncing { background: rgba(255,255,255,0.2); color: white; }
  .sync-indicator.synced { background: rgba(34, 197, 94, 0.3); color: white; }
  .sync-indicator.error { background: rgba(239, 68, 68, 0.3); color: white; }

  /* Date nav */
  .date-nav {
    display: flex; align-items: center; justify-content: center; gap: 16px;
    padding: 10px 20px 14px;
    background: linear-gradient(135deg, #0d9488 0%, #2dd4bf 50%, #5eead4 100%);
    color: white;
  }

  .date-nav button {
    background: rgba(255,255,255,0.2); border: none; color: white;
    width: 36px; height: 36px; border-radius: 50%; font-size: 18px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent; min-height: 44px; min-width: 44px;
  }

  .date-nav button:disabled { opacity: 0.3; cursor: default; }
  .date-nav button:active:not(:disabled) { background: rgba(255,255,255,0.35); }

  .date-label {
    font-size: 15px; font-weight: 600; cursor: pointer;
    -webkit-tap-highlight-color: transparent; text-align: center; min-width: 180px;
  }

  .date-label .today-hint { font-size: 11px; font-weight: 400; opacity: 0.8; display: block; }

  /* View toggle */
  .view-toggle {
    display: flex; justify-content: center; gap: 4px;
    padding: 0 20px 14px;
    background: linear-gradient(135deg, #0d9488 0%, #2dd4bf 50%, #5eead4 100%);
  }

  .view-toggle button {
    padding: 6px 20px; font-size: 13px; font-weight: 600;
    border: 1.5px solid rgba(255,255,255,0.35); border-radius: 20px;
    background: transparent; color: rgba(255,255,255,0.8);
    cursor: pointer; -webkit-tap-highlight-color: transparent;
    font-family: inherit; min-height: 36px;
  }

  .view-toggle button.active {
    background: white; color: var(--accent); border-color: white;
  }

  .view-toggle button:not(.active):active { background: rgba(255,255,255,0.15); }

  /* Summary cards */
  .summary-card {
    background: var(--card); border-radius: 14px; margin-bottom: 10px;
    box-shadow: 0 1px 4px rgba(19, 78, 74, 0.06); border: 1px solid var(--border);
    overflow: hidden; padding: 16px;
  }

  .summary-card-title {
    font-size: 13px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 12px;
  }

  .stat-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
  }

  .stat-box {
    background: var(--bg); border-radius: 10px; padding: 12px;
    text-align: center;
  }

  .stat-box-value { font-size: 24px; font-weight: 700; color: var(--text); }
  .stat-box-label { font-size: 11px; font-weight: 500; color: var(--text-secondary); margin-top: 2px; }
  .stat-box-sub { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

  .stat-box-value.green { color: var(--green-dark); }
  .stat-box-value.red { color: var(--red); }
  .stat-box-value.neutral { color: var(--text-secondary); }

  .exercise-stat-row {
    display: flex; align-items: center; padding: 8px 0;
    border-bottom: 1px solid var(--border); gap: 10px;
  }

  .exercise-stat-row:last-child { border-bottom: none; }

  .exercise-stat-name { flex: 1; font-size: 14px; font-weight: 500; }

  .exercise-stat-bar {
    width: 80px; height: 8px; background: var(--border); border-radius: 4px;
    overflow: hidden;
  }

  .exercise-stat-fill {
    height: 100%; background: var(--accent); border-radius: 4px;
    transition: width 0.3s;
  }

  .exercise-stat-count {
    font-size: 13px; font-weight: 600; color: var(--accent); min-width: 36px;
    text-align: right;
  }

  .rating-summary-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
  }

  .rating-summary-row:last-child { margin-bottom: 0; }

  .rating-summary-dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  }

  .rating-summary-label { font-size: 13px; font-weight: 500; min-width: 70px; }

  .rating-summary-bar {
    flex: 1; height: 8px; background: var(--border); border-radius: 4px;
    overflow: hidden;
  }

  .rating-summary-fill {
    height: 100%; border-radius: 4px; transition: width 0.3s;
  }

  .rating-summary-fill.green { background: var(--green); }
  .rating-summary-fill.yellow { background: var(--yellow); }
  .rating-summary-fill.red { background: var(--red); }

  .rating-summary-count { font-size: 12px; color: var(--text-secondary); min-width: 20px; text-align: right; }

  .weight-mini-chart {
    display: flex; align-items: flex-end; gap: 3px; height: 60px;
    padding: 8px 0;
  }

  .weight-mini-bar {
    flex: 1; background: rgba(13, 148, 136, 0.15); border-radius: 3px 3px 0 0;
    min-width: 4px; position: relative;
  }

  .weight-mini-bar.has-data { background: var(--accent); }

  .weight-mini-label {
    font-size: 9px; color: var(--text-secondary); text-align: center;
    margin-top: 4px;
  }

  .weight-mini-row {
    display: flex; gap: 3px; padding: 0 4px;
  }

  .weight-mini-col {
    flex: 1; display: flex; flex-direction: column; align-items: center;
  }

  /* Sections */
  .content { padding: 10px 12px; padding-bottom: calc(40px + var(--safe-bottom)); }

  .section {
    background: var(--card); border-radius: 14px; margin-bottom: 10px;
    box-shadow: 0 1px 4px rgba(19, 78, 74, 0.06); border: 1px solid var(--border);
    overflow: hidden;
  }

  .section-header {
    display: flex; align-items: center; padding: 14px 16px; gap: 10px;
    cursor: pointer; -webkit-tap-highlight-color: transparent; min-height: 52px;
  }

  .section-header:active { background: #f0fdfb; }
  .section-icon { font-size: 20px; flex-shrink: 0; }
  .section-title { font-size: 15px; font-weight: 700; flex: 1; }
  .section-summary { font-size: 12px; color: var(--text-secondary); font-weight: 400; }

  .section-chevron {
    font-size: 12px; color: var(--text-secondary); transition: transform 0.2s;
    flex-shrink: 0;
  }

  .section.collapsed .section-chevron { transform: rotate(-90deg); }
  .section-body { border-top: 1px solid var(--border); }
  .section.collapsed .section-body { display: none; }

  /* Weight */
  .weight-display {
    display: flex; align-items: baseline; gap: 8px;
    padding: 16px; justify-content: center;
  }

  .weight-value { font-size: 36px; font-weight: 700; color: var(--text); }
  .weight-unit { font-size: 16px; color: var(--text-secondary); font-weight: 500; }

  .weight-trend { font-size: 14px; font-weight: 600; margin-left: 4px; }
  .weight-trend.down { color: var(--green-dark); }
  .weight-trend.up { color: var(--red); }
  .weight-trend.same { color: var(--text-secondary); }

  .weight-input-row {
    display: flex; gap: 10px; padding: 16px; align-items: center; justify-content: center;
  }

  .weight-input-row input {
    width: 120px; padding: 10px 14px; font-size: 20px; font-weight: 600;
    border: 1.5px solid var(--border); border-radius: 10px; background: var(--bg);
    text-align: center; font-family: inherit; color: var(--text);
    min-height: 48px; appearance: none; -webkit-appearance: none;
  }

  .weight-input-row input:focus {
    outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .weight-input-row .log-btn {
    padding: 10px 20px; font-size: 15px; font-weight: 600;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white; border: none; border-radius: 10px; cursor: pointer;
    min-height: 48px; font-family: inherit;
    box-shadow: 0 2px 8px var(--accent-glow);
    -webkit-tap-highlight-color: transparent;
  }

  .weight-input-row .log-btn:active { transform: scale(0.95); }

  .weight-edit-btn {
    background: none; border: none; color: var(--accent); font-size: 13px;
    font-weight: 500; cursor: pointer; padding: 4px 8px; font-family: inherit;
    -webkit-tap-highlight-color: transparent;
  }

  .weight-history { padding: 0 16px 12px; }
  .weight-history-title {
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 6px;
  }

  .weight-history-item {
    display: flex; justify-content: space-between; padding: 4px 0;
    font-size: 13px; color: var(--text-secondary);
  }

  .weight-history-item strong { color: var(--text); font-weight: 600; }

  /* Exercise rows */
  .exercise-row {
    display: flex; align-items: center; padding: 12px 16px; gap: 12px;
    border-bottom: 1px solid var(--border); min-height: 52px;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
  }

  .exercise-row:last-of-type { border-bottom: none; }
  .exercise-row.done { background: rgba(13, 148, 136, 0.04); }

  .exercise-check {
    width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s; font-size: 14px; color: transparent;
  }

  .exercise-row.done .exercise-check {
    background: var(--accent); border-color: var(--accent); color: white;
  }

  .exercise-label { flex: 1; font-size: 14px; font-weight: 500; }

  .exercise-freq {
    font-size: 11px; font-weight: 600; color: var(--accent);
    background: rgba(13, 148, 136, 0.08); padding: 3px 8px; border-radius: 10px;
  }

  .exercise-notes {
    padding: 0 16px 12px 56px;
    border-bottom: 1px solid var(--border);
  }

  .exercise-notes input {
    width: 100%; padding: 8px 12px; font-size: 13px;
    border: 1px solid var(--border); border-radius: 8px; background: var(--bg);
    font-family: inherit; color: var(--text); min-height: 40px;
  }

  .exercise-notes input:focus {
    outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow);
  }

  /* Nutrition */
  .vitamin-row {
    display: flex; align-items: center; padding: 12px 16px; gap: 12px;
    border-bottom: 1px solid var(--border); min-height: 52px;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
  }

  .vitamin-row.done { background: rgba(13, 148, 136, 0.04); }
  .vitamin-row.done .exercise-check {
    background: var(--accent); border-color: var(--accent); color: white;
  }

  .meal-row {
    display: flex; align-items: center; padding: 12px 16px; gap: 12px;
    border-bottom: 1px solid var(--border); min-height: 52px;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
  }

  .meal-row:last-of-type { border-bottom: none; }

  .drinks-row {
    display: flex; align-items: center; padding: 12px 16px; gap: 12px;
    border-bottom: 1px solid var(--border); min-height: 52px;
  }

  .drinks-label { font-size: 14px; font-weight: 500; flex: 1; }

  .drinks-counter {
    display: flex; align-items: center; gap: 10px;
  }

  .drinks-counter button {
    width: 34px; height: 34px; border-radius: 50%; border: 1.5px solid var(--border);
    background: var(--bg); font-size: 18px; font-weight: 600; color: var(--accent);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
    min-height: 44px; min-width: 44px;
  }

  .drinks-counter button:active { background: var(--accent); color: white; border-color: var(--accent); }

  .drinks-count {
    font-size: 20px; font-weight: 700; min-width: 28px; text-align: center;
    color: var(--text);
  }

  .drinks-weekly {
    font-size: 11px; font-weight: 600; color: var(--text-secondary);
    background: rgba(13, 148, 136, 0.08); padding: 3px 8px; border-radius: 10px;
  }
  .meal-row:active { background: #f0fdfb; }

  .meal-name { font-size: 14px; font-weight: 500; min-width: 80px; }

  .meal-summary {
    flex: 1; font-size: 13px; color: var(--text-secondary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .meal-summary.empty { font-style: italic; opacity: 0.6; }

  .rating-dot {
    width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
  }

  .rating-dot.green { background: var(--green); }
  .rating-dot.yellow { background: var(--yellow); }
  .rating-dot.red { background: var(--red); }
  .rating-dot.none { background: var(--border); }

  /* Meal modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(19, 78, 74, 0.45);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    z-index: 100; align-items: flex-end; justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--card); border-radius: 20px 20px 0 0;
    width: 100%; max-width: 500px; padding: 28px 24px;
    padding-bottom: calc(28px + var(--safe-bottom));
    animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }

  .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 24px; color: var(--text); }

  .form-group { margin-bottom: 18px; }

  .form-group label {
    display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px;
    color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;
  }

  .form-group input {
    width: 100%; padding: 12px 14px; font-size: 16px;
    border: 1.5px solid var(--border); border-radius: 10px; background: var(--bg);
    min-height: 48px; font-family: inherit; color: var(--text);
    appearance: none; -webkit-appearance: none;
  }

  .form-group input:focus {
    outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .rating-picker { display: flex; gap: 12px; justify-content: center; margin-top: 8px; }

  .rating-option {
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
    padding: 8px 16px; border-radius: 12px; border: 2px solid transparent;
    transition: all 0.15s; min-width: 80px;
  }

  .rating-option .rating-circle {
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; transition: transform 0.15s;
  }

  .rating-option.green .rating-circle { background: var(--green); }
  .rating-option.yellow .rating-circle { background: var(--yellow); }
  .rating-option.red .rating-circle { background: var(--red); }

  .rating-option .rating-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); }

  .rating-option.selected { border-color: var(--accent); background: rgba(13, 148, 136, 0.05); }
  .rating-option.selected .rating-circle { transform: scale(1.15); }
  .rating-option:not(.selected) { opacity: 0.5; }
  .rating-option.none-selected { opacity: 1; }

  .modal-actions { display: flex; gap: 10px; margin-top: 28px; }

  .modal-actions button {
    flex: 1; padding: 14px; font-size: 15px; font-weight: 600;
    border-radius: 12px; border: none; cursor: pointer; min-height: 50px;
    -webkit-tap-highlight-color: transparent; font-family: inherit;
  }

  .modal-actions button:active { transform: scale(0.97); }

  .btn-cancel { background: var(--bg); color: var(--text-secondary); border: 1.5px solid var(--border); }

  .btn-save {
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white; box-shadow: 0 2px 10px var(--accent-glow);
  }

  .btn-clear {
    background: none; border: 1.5px solid var(--red); color: var(--red-dark);
  }

  /* Toast */
  .toast {
    position: fixed; bottom: calc(40px + var(--safe-bottom)); left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--text); color: white; padding: 12px 24px; border-radius: 12px;
    font-size: 14px; font-weight: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    z-index: 50; opacity: 0; pointer-events: none;
    transition: opacity 0.2s, transform 0.2s; font-family: inherit;
  }

  .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

  /* Skin section */
  .skin-item {
    display: flex; align-items: center; padding: 12px 16px; gap: 12px;
    border-bottom: 1px solid var(--border); min-height: 52px;
  }

  .skin-item:last-of-type { border-bottom: none; }

  .skin-status-dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  }

  .skin-status-dot.green { background: var(--green); }
  .skin-status-dot.yellow { background: var(--yellow); }
  .skin-status-dot.red { background: var(--red); }
  .skin-status-dot.none { background: var(--border); }

  .skin-item-info { flex: 1; min-width: 0; }

  .skin-item-name {
    font-size: 14px; font-weight: 500; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }

  .skin-item-meta {
    font-size: 11px; color: var(--text-secondary); margin-top: 1px;
  }

  .skin-done-btn {
    padding: 6px 16px; font-size: 13px; font-weight: 600;
    background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px;
    color: var(--accent); cursor: pointer; flex-shrink: 0;
    -webkit-tap-highlight-color: transparent; font-family: inherit; min-height: 36px;
  }

  .skin-done-btn:active {
    background: var(--accent); color: white; border-color: var(--accent);
  }

  .skin-empty {
    padding: 24px 16px; text-align: center;
    font-size: 14px; color: var(--text-secondary);
  }

  .skin-item-detail {
    padding: 0 16px 12px; border-bottom: 1px solid var(--border);
  }

  .skin-detail-row {
    display: flex; align-items: center; gap: 8px; padding: 4px 0;
    font-size: 12px; color: var(--text-secondary);
  }

  .skin-detail-actions {
    display: flex; gap: 8px; margin-top: 8px;
  }

  .skin-detail-actions button {
    font-size: 12px; font-weight: 500; padding: 4px 12px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--bg); color: var(--text-secondary);
    cursor: pointer; font-family: inherit; -webkit-tap-highlight-color: transparent;
  }

  .skin-detail-actions button.delete { border-color: var(--red); color: var(--red); }

  /* FAB */
  .fab {
    position: fixed; bottom: calc(24px + var(--safe-bottom)); right: 20px;
    width: 56px; height: 56px; border-radius: 50%; border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white; font-size: 28px; font-weight: 300;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px var(--accent-glow);
    cursor: pointer; z-index: 9;
    -webkit-tap-highlight-color: transparent;
  }

  .fab:active { transform: scale(0.9); }

  /* Skin add/edit modal */
  .form-group select {
    width: 100%; padding: 12px 14px; font-size: 16px;
    border: 1.5px solid var(--border); border-radius: 10px; background: var(--bg);
    min-height: 48px; font-family: inherit; color: var(--text);
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235f7a78' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
  }

  .form-group select:focus {
    outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .freq-row {
    display: flex; gap: 10px; align-items: center;
  }

  .freq-row input {
    width: 80px; text-align: center;
  }

  .freq-row select {
    flex: 1;
  }

  @media (min-width: 600px) {
    .content { max-width: 540px; margin: 0 auto; padding: 16px; padding-bottom: 60px; }
    .header-inner { justify-content: center; }
    .header-tagline { text-align: center; }
    .modal { border-radius: 20px; margin-bottom: 40px; }
    .modal-overlay { align-items: center; }
    .fab { right: calc(50% - 270px + 20px); }
  }
</style>
</head>
<body>

<header>
  <div class="header-inner"><h1>Body</h1></div>
  <div class="header-bottom">
    <p class="header-tagline">Feel good, move more</p>
    <span class="sync-indicator" id="sync-status"></span>
  </div>
</header>

<div class="date-nav">
  <button id="date-prev" aria-label="Previous day">&#8249;</button>
  <span class="date-label" id="date-label"></span>
  <button id="date-next" aria-label="Next day">&#8250;</button>
</div>

<div class="view-toggle" id="view-toggle">
  <button class="active" data-view="day">Day</button>
  <button data-view="week">Week</button>
  <button data-view="month">Month</button>
</div>

<div class="content">
  <!-- Summary (week/month) -->
  <div id="summary-content" style="display:none;"></div>

  <!-- Day view -->
  <div id="day-content">
  <!-- Weight -->
  <div class="section" id="sec-weight">
    <div class="section-header" data-section="weight">
      <span class="section-icon">&#9878;</span>
      <span class="section-title">Weight</span>
      <span class="section-summary" id="weight-summary"></span>
      <span class="section-chevron">&#9662;</span>
    </div>
    <div class="section-body" id="weight-body"></div>
  </div>

  <!-- Exercise -->
  <div class="section" id="sec-exercise">
    <div class="section-header" data-section="exercise">
      <span class="section-icon">&#127947;</span>
      <span class="section-title">Exercise</span>
      <span class="section-summary" id="exercise-summary"></span>
      <span class="section-chevron">&#9662;</span>
    </div>
    <div class="section-body" id="exercise-body"></div>
  </div>

  <!-- Nutrition -->
  <div class="section" id="sec-nutrition">
    <div class="section-header" data-section="nutrition">
      <span class="section-icon">&#127869;</span>
      <span class="section-title">Nutrition</span>
      <span class="section-summary" id="nutrition-summary"></span>
      <span class="section-chevron">&#9662;</span>
    </div>
    <div class="section-body" id="nutrition-body"></div>
  </div>
  <!-- Skin -->
  <div class="section" id="sec-skin">
    <div class="section-header" data-section="skin">
      <span class="section-icon">&#10024;</span>
      <span class="section-title">Skin</span>
      <span class="section-summary" id="skin-summary"></span>
      <span class="section-chevron">&#9662;</span>
    </div>
    <div class="section-body" id="skin-body"></div>
  </div>
  </div><!-- /day-content -->
</div>

<button class="fab" id="fab-add" style="display:none" aria-label="Add skin item">+</button>

<div class="toast" id="toast"></div>

<!-- Skin item modal -->
<div class="modal-overlay" id="skin-modal-overlay">
  <div class="modal">
    <h2 id="skin-modal-title">Add Skin Item</h2>
    <div class="form-group">
      <label for="skin-name-input">Name</label>
      <input type="text" id="skin-name-input" placeholder="e.g. Moisturize face" autocomplete="off">
    </div>
    <div class="form-group">
      <label>Expected frequency</label>
      <div class="freq-row">
        <input type="number" id="skin-freq-num" value="1" min="1" inputmode="numeric">
        <select id="skin-freq-unit">
          <option value="days">days</option>
          <option value="weeks" selected>weeks</option>
          <option value="months">months</option>
        </select>
      </div>
    </div>
    <div class="modal-actions" id="skin-modal-actions">
      <button class="btn-cancel" id="skin-cancel">Cancel</button>
      <button class="btn-save" id="skin-save">Save</button>
    </div>
  </div>
</div>

<!-- Meal modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h2 id="modal-title">Log Meal</h2>
    <div class="form-group">
      <label for="meal-input">What did you have?</label>
      <input type="text" id="meal-input" placeholder="e.g. Oatmeal with berries" autocomplete="off">
    </div>
    <div class="form-group">
      <label>How was it?</label>
      <div class="rating-picker" id="rating-picker">
        <div class="rating-option green none-selected" data-rating="green">
          <div class="rating-circle">&#10003;</div>
          <span class="rating-label">Healthy</span>
        </div>
        <div class="rating-option yellow none-selected" data-rating="yellow">
          <div class="rating-circle">~</div>
          <span class="rating-label">Okay</span>
        </div>
        <div class="rating-option red none-selected" data-rating="red">
          <div class="rating-circle">!</div>
          <span class="rating-label">Unhealthy</span>
        </div>
      </div>
    </div>
    <div class="modal-actions" id="modal-actions">
      <button class="btn-cancel" id="meal-cancel">Cancel</button>
      <button class="btn-save" id="meal-save">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const STORAGE_KEY = 'bodyTracker';
  const SYNC_URL = 'https://script.google.com/macros/s/AKfycbzAM4XV1EMoIKsP5x88blS_4cYZ7qPG0aWn_vP2FEB4XjCUDSnStARZZCFzRPTVR2Y3VQ/exec?app=body';

  const EXERCISES = [
    { key: 'morning-stretch', label: 'Morning Stretch' },
    { key: 'walking', label: 'Walking' },
    { key: 'weight-training', label: 'Weight Training' },
    { key: 'class', label: 'Class' },
    { key: 'other', label: 'Other' }
  ];

  const MEALS = ['breakfast', 'lunch', 'dinner', 'snacks'];
  const MEAL_LABELS = { breakfast: 'Breakfast', lunch: 'Lunch', dinner: 'Dinner', snacks: 'Snacks' };

  // --- Data layer ---
  let data = { days: {} };

  function loadLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) data = JSON.parse(raw);
      if (!data.days) data.days = {};
      if (!data.skinItems) data.skinItems = [];
    } catch { data = { days: {}, skinItems: [] }; }
  }

  function saveLocal() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function syncToCloud() {
    setSyncStatus('syncing');
    fetch(SYNC_URL, { method: 'POST', redirect: 'follow', body: JSON.stringify(data) })
      .then(r => { if (r.ok || r.redirected) setSyncStatus('synced'); else setSyncStatus('error'); })
      .catch(() => setSyncStatus('error'));
  }

  function syncFromCloud() {
    setSyncStatus('syncing');
    fetch(SYNC_URL, { redirect: 'follow' })
      .then(r => r.text())
      .then(text => {
        try {
          const cloud = JSON.parse(text);
          if (cloud.days && Object.keys(cloud.days).length > 0) {
            data = cloud;
            saveLocal();
            render();
          }
          setSyncStatus('synced');
        } catch { setSyncStatus('error'); }
      })
      .catch(() => setSyncStatus('error'));
  }

  function save() { saveLocal(); syncToCloud(); }

  function setSyncStatus(s) {
    const el = document.getElementById('sync-status');
    el.className = 'sync-indicator ' + s;
    el.textContent = s === 'syncing' ? 'Syncing...' : s === 'synced' ? 'Synced' : 'Offline';
  }

  function dateKey(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return y + '-' + m + '-' + day;
  }

  function getDay(dk) {
    if (!data.days[dk]) {
      data.days[dk] = {
        weight: null,
        exercises: {},
        vitamins: false,
        drinks: 0,
        meals: {}
      };
      EXERCISES.forEach(ex => { data.days[dk].exercises[ex.key] = { done: false, notes: '' }; });
      MEALS.forEach(m => { data.days[dk].meals[m] = { summary: '', rating: null }; });
    }
    // Ensure all exercises and meals exist
    const day = data.days[dk];
    if (day.drinks == null) day.drinks = 0;
    EXERCISES.forEach(ex => { if (!day.exercises[ex.key]) day.exercises[ex.key] = { done: false, notes: '' }; });
    MEALS.forEach(m => { if (!day.meals[m]) day.meals[m] = { summary: '', rating: null }; });
    return day;
  }

  // --- State ---
  let currentDate = new Date();
  let currentView = 'day'; // 'day', 'week', 'month'
  let editingMeal = null;
  let selectedRating = null;
  let collapsed = { weight: false, exercise: false, nutrition: false, skin: false };
  let expandedSkinItem = null;
  let editingSkinItem = null; // null = adding new, string = editing id
  let undoTimer = null;

  // --- DOM ---
  const dateLabelEl = document.getElementById('date-label');
  const datePrevEl = document.getElementById('date-prev');
  const dateNextEl = document.getElementById('date-next');
  const weightBody = document.getElementById('weight-body');
  const exerciseBody = document.getElementById('exercise-body');
  const nutritionBody = document.getElementById('nutrition-body');
  const weightSummary = document.getElementById('weight-summary');
  const exerciseSummary = document.getElementById('exercise-summary');
  const nutritionSummary = document.getElementById('nutrition-summary');
  const dayContent = document.getElementById('day-content');
  const summaryContent = document.getElementById('summary-content');
  const viewToggle = document.getElementById('view-toggle');
  const skinBody = document.getElementById('skin-body');
  const skinSummary = document.getElementById('skin-summary');
  const fabEl = document.getElementById('fab-add');
  const skinOverlay = document.getElementById('skin-modal-overlay');
  const skinModalTitle = document.getElementById('skin-modal-title');
  const skinNameInput = document.getElementById('skin-name-input');
  const skinFreqNum = document.getElementById('skin-freq-num');
  const skinFreqUnit = document.getElementById('skin-freq-unit');
  const skinModalActions = document.getElementById('skin-modal-actions');
  const toastEl = document.getElementById('toast');
  const overlayEl = document.getElementById('modal-overlay');
  const modalTitle = document.getElementById('modal-title');
  const mealInput = document.getElementById('meal-input');
  const ratingPicker = document.getElementById('rating-picker');
  const mealSave = document.getElementById('meal-save');
  const mealCancel = document.getElementById('meal-cancel');
  const modalActions = document.getElementById('modal-actions');

  // --- View toggle ---
  viewToggle.addEventListener('click', e => {
    const btn = e.target.closest('[data-view]');
    if (!btn || btn.dataset.view === currentView) return;
    currentView = btn.dataset.view;
    viewToggle.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.view === currentView));
    render();
  });

  // --- Date nav ---
  function getWeekRange(d) {
    const day = d.getDay();
    const mon = new Date(d);
    mon.setDate(d.getDate() - ((day + 6) % 7)); // Monday
    const sun = new Date(mon);
    sun.setDate(mon.getDate() + 6); // Sunday
    return { start: mon, end: sun };
  }

  function updateDateNav() {
    const today = new Date();

    if (currentView === 'day') {
      const isToday = dateKey(currentDate) === dateKey(today);
      const opts = { weekday: 'long', month: 'short', day: 'numeric' };
      dateLabelEl.innerHTML = currentDate.toLocaleDateString(undefined, opts) +
        (isToday ? '<span class="today-hint">Today</span>' : '');
      dateNextEl.disabled = isToday;
    } else if (currentView === 'week') {
      const week = getWeekRange(currentDate);
      const sOpts = { month: 'short', day: 'numeric' };
      const thisWeek = getWeekRange(today);
      const isThisWeek = dateKey(week.start) === dateKey(thisWeek.start);
      dateLabelEl.innerHTML = week.start.toLocaleDateString(undefined, sOpts) + ' â€“ ' +
        week.end.toLocaleDateString(undefined, sOpts) +
        (isThisWeek ? '<span class="today-hint">This Week</span>' : '');
      dateNextEl.disabled = isThisWeek;
    } else {
      const isThisMonth = currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear();
      const mOpts = { month: 'long', year: 'numeric' };
      dateLabelEl.innerHTML = currentDate.toLocaleDateString(undefined, mOpts) +
        (isThisMonth ? '<span class="today-hint">This Month</span>' : '');
      dateNextEl.disabled = isThisMonth;
    }
  }

  datePrevEl.addEventListener('click', () => {
    if (currentView === 'day') {
      currentDate.setDate(currentDate.getDate() - 1);
    } else if (currentView === 'week') {
      currentDate.setDate(currentDate.getDate() - 7);
    } else {
      currentDate.setMonth(currentDate.getMonth() - 1);
    }
    render();
  });

  dateNextEl.addEventListener('click', () => {
    const today = new Date();
    if (currentView === 'day') {
      if (dateKey(currentDate) < dateKey(today)) currentDate.setDate(currentDate.getDate() + 1);
    } else if (currentView === 'week') {
      const thisWeek = getWeekRange(today);
      const curWeek = getWeekRange(currentDate);
      if (dateKey(curWeek.start) < dateKey(thisWeek.start)) currentDate.setDate(currentDate.getDate() + 7);
    } else {
      const isThisMonth = currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear();
      if (!isThisMonth) currentDate.setMonth(currentDate.getMonth() + 1);
    }
    render();
  });

  dateLabelEl.addEventListener('click', () => {
    currentDate = new Date();
    render();
  });

  // --- Section collapse ---
  document.querySelectorAll('.section-header').forEach(hdr => {
    hdr.addEventListener('click', () => {
      const sec = hdr.dataset.section;
      collapsed[sec] = !collapsed[sec];
      hdr.closest('.section').classList.toggle('collapsed', collapsed[sec]);
    });
  });

  // --- Render ---
  function render() {
    updateDateNav();

    if (currentView === 'day') {
      dayContent.style.display = '';
      summaryContent.style.display = 'none';
      const dk = dateKey(currentDate);
      const day = getDay(dk);
      renderWeight(day, dk);
      renderExercise(day, dk);
      renderNutrition(day, dk);
      renderSkin();
    } else {
      dayContent.style.display = 'none';
      summaryContent.style.display = '';
      fabEl.style.display = 'none';
      renderSummary();
    }
  }

  // --- Weight ---
  function renderWeight(day, dk) {
    const w = day.weight;
    const trend = getWeightTrend(dk);

    let html = '';
    if (w !== null && w !== undefined) {
      let trendHtml = '';
      if (trend) {
        const cls = trend.dir === 'down' ? 'down' : trend.dir === 'up' ? 'up' : 'same';
        const arrow = trend.dir === 'down' ? '&#9660;' : trend.dir === 'up' ? '&#9650;' : '&#8211;';
        const diff = Math.abs(trend.diff).toFixed(1);
        trendHtml = '<span class="weight-trend ' + cls + '">' + arrow + ' ' + diff + '</span>';
      }
      html += '<div class="weight-display">';
      html += '<span class="weight-value">' + w + '</span>';
      html += '<span class="weight-unit">lbs</span>';
      html += trendHtml;
      html += '<button class="weight-edit-btn" id="weight-edit">edit</button>';
      html += '</div>';
    } else {
      html += '<div class="weight-input-row">';
      html += '<input type="number" id="weight-input" step="0.1" inputmode="decimal" placeholder="0.0">';
      html += '<button class="log-btn" id="weight-log">Log</button>';
      html += '</div>';
    }

    // History
    const history = getWeightHistory(dk, 5);
    if (history.length > 0) {
      html += '<div class="weight-history">';
      html += '<p class="weight-history-title">Recent</p>';
      history.forEach(h => {
        const d = new Date(h.date + 'T12:00:00');
        const label = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        html += '<div class="weight-history-item"><span>' + label + '</span><strong>' + h.weight + ' lbs</strong></div>';
      });
      html += '</div>';
    }

    weightBody.innerHTML = html;
    weightSummary.textContent = w ? w + ' lbs' + (trend ? (trend.dir === 'down' ? ' (down)' : trend.dir === 'up' ? ' (up)' : '') : '') : 'Not logged';

    // Wire events
    const logBtn = document.getElementById('weight-log');
    if (logBtn) {
      logBtn.addEventListener('click', () => {
        const input = document.getElementById('weight-input');
        const val = parseFloat(input.value);
        if (!val || val <= 0) return;
        day.weight = val;
        save();
        showToast('Weight logged');
        render();
      });
    }

    const editBtn = document.getElementById('weight-edit');
    if (editBtn) {
      editBtn.addEventListener('click', () => {
        day.weight = null;
        render();
      });
    }
  }

  function getWeightTrend(dk) {
    const sortedDays = Object.keys(data.days).filter(k => k < dk && data.days[k].weight != null).sort().reverse();
    if (sortedDays.length === 0) return null;
    const prev = data.days[sortedDays[0]].weight;
    const cur = data.days[dk] && data.days[dk].weight;
    if (cur == null) return null;
    const diff = cur - prev;
    return { dir: diff < -0.05 ? 'down' : diff > 0.05 ? 'up' : 'same', diff };
  }

  function getWeightHistory(excludeKey, count) {
    return Object.keys(data.days)
      .filter(k => k !== excludeKey && data.days[k].weight != null)
      .sort().reverse()
      .slice(0, count)
      .map(k => ({ date: k, weight: data.days[k].weight }));
  }

  // --- Exercise ---
  function renderExercise(day, dk) {
    let html = '';
    let doneCount = 0;

    EXERCISES.forEach(ex => {
      const e = day.exercises[ex.key];
      const isDone = e && e.done;
      if (isDone) doneCount++;
      const freq = exerciseFreq(ex.key);

      html += '<div class="exercise-row' + (isDone ? ' done' : '') + '" data-ex="' + ex.key + '">';
      html += '<div class="exercise-check">' + (isDone ? '&#10003;' : '') + '</div>';
      html += '<span class="exercise-label">' + ex.label + '</span>';
      html += '<span class="exercise-freq">' + freq + '/7</span>';
      html += '</div>';

      if (isDone) {
        html += '<div class="exercise-notes" data-ex-notes="' + ex.key + '">';
        html += '<input type="text" placeholder="Add notes..." value="' + escapeAttr(e.notes || '') + '">';
        html += '</div>';
      }
    });

    exerciseBody.innerHTML = html;
    exerciseSummary.textContent = doneCount + ' of ' + EXERCISES.length + ' done';

    // Wire toggle events
    exerciseBody.querySelectorAll('.exercise-row').forEach(row => {
      row.addEventListener('click', () => {
        const key = row.dataset.ex;
        day.exercises[key].done = !day.exercises[key].done;
        if (!day.exercises[key].done) day.exercises[key].notes = '';
        save();
        render();
      });
    });

    // Wire notes events
    exerciseBody.querySelectorAll('.exercise-notes input').forEach(input => {
      const key = input.closest('[data-ex-notes]').dataset.exNotes;
      input.addEventListener('click', e => e.stopPropagation());
      input.addEventListener('change', () => {
        day.exercises[key].notes = input.value;
        save();
      });
    });
  }

  function exerciseFreq(key) {
    let count = 0;
    const today = new Date();
    for (let i = 0; i < 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dk = dateKey(d);
      if (data.days[dk] && data.days[dk].exercises[key] && data.days[dk].exercises[key].done) count++;
    }
    return count;
  }

  // --- Nutrition ---
  function renderNutrition(day, dk) {
    let html = '';

    // Vitamins
    html += '<div class="vitamin-row' + (day.vitamins ? ' done' : '') + '" id="vitamin-toggle">';
    html += '<div class="exercise-check">' + (day.vitamins ? '&#10003;' : '') + '</div>';
    html += '<span class="exercise-label">Vitamins</span>';
    html += '</div>';

    // Drinks counter
    const weeklyDrinks = getWeeklyDrinks();
    html += '<div class="drinks-row">';
    html += '<span class="drinks-label">Drinks</span>';
    html += '<span class="drinks-weekly">' + weeklyDrinks + ' this week</span>';
    html += '<div class="drinks-counter">';
    html += '<button id="drinks-minus" aria-label="Decrease">&minus;</button>';
    html += '<span class="drinks-count" id="drinks-count">' + (day.drinks || 0) + '</span>';
    html += '<button id="drinks-plus" aria-label="Increase">+</button>';
    html += '</div>';
    html += '</div>';

    // Meals
    let loggedCount = 0;
    MEALS.forEach(m => {
      const meal = day.meals[m];
      const hasData = meal && meal.summary;
      if (hasData) loggedCount++;
      const ratingClass = meal && meal.rating ? meal.rating : 'none';

      html += '<div class="meal-row" data-meal="' + m + '">';
      html += '<span class="meal-name">' + MEAL_LABELS[m] + '</span>';
      html += '<span class="meal-summary' + (!hasData ? ' empty' : '') + '">' + (hasData ? escapeHtml(meal.summary) : 'Tap to log') + '</span>';
      html += '<div class="rating-dot ' + ratingClass + '"></div>';
      html += '</div>';
    });

    nutritionBody.innerHTML = html;

    const drinksLabel = day.drinks > 0 ? day.drinks + ' drink' + (day.drinks !== 1 ? 's' : '') : '';
    const vitLabel = day.vitamins ? 'Vitamins' : '';
    const summaryParts = [loggedCount + '/' + MEALS.length + ' meals', vitLabel, drinksLabel].filter(Boolean);
    nutritionSummary.textContent = summaryParts.join(' \u00b7 ');

    // Vitamin toggle
    document.getElementById('vitamin-toggle').addEventListener('click', () => {
      day.vitamins = !day.vitamins;
      save();
      showToast(day.vitamins ? 'Vitamins taken!' : 'Vitamins unmarked');
      render();
    });

    // Drinks counter
    document.getElementById('drinks-minus').addEventListener('click', () => {
      if (day.drinks > 0) { day.drinks--; save(); render(); }
    });
    document.getElementById('drinks-plus').addEventListener('click', () => {
      day.drinks = (day.drinks || 0) + 1; save(); render();
    });

    // Meal rows
    nutritionBody.querySelectorAll('.meal-row').forEach(row => {
      row.addEventListener('click', () => openMealModal(row.dataset.meal, dk));
    });
  }

  // --- Skin ---
  function getSkinStatus(item) {
    if (!item.completions || item.completions.length === 0) {
      const created = new Date(item.createdAt).getTime();
      const elapsed = Date.now() - created;
      const intervalMs = item.intervalDays * 86400000;
      const ratio = elapsed / intervalMs;
      return ratio > 1 ? 'red' : ratio > 0.7 ? 'yellow' : 'green';
    }
    const last = new Date(item.completions[item.completions.length - 1]).getTime();
    const elapsed = Date.now() - last;
    const intervalMs = item.intervalDays * 86400000;
    const ratio = elapsed / intervalMs;
    return ratio > 1 ? 'red' : ratio > 0.7 ? 'yellow' : 'green';
  }

  function getSkinUrgency(item) {
    if (!item.completions || item.completions.length === 0) {
      const created = new Date(item.createdAt).getTime();
      return (Date.now() - created) / (item.intervalDays * 86400000);
    }
    const last = new Date(item.completions[item.completions.length - 1]).getTime();
    return (Date.now() - last) / (item.intervalDays * 86400000);
  }

  function formatTimeAgo(isoStr) {
    const ms = Date.now() - new Date(isoStr).getTime();
    const mins = Math.floor(ms / 60000);
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    return days + 'd ago';
  }

  function formatInterval(days) {
    if (days % 30 === 0 && days >= 30) return 'every ' + (days / 30) + ' month' + (days / 30 !== 1 ? 's' : '');
    if (days % 7 === 0 && days >= 7) return 'every ' + (days / 7) + ' week' + (days / 7 !== 1 ? 's' : '');
    return 'every ' + days + ' day' + (days !== 1 ? 's' : '');
  }

  function renderSkin() {
    if (!data.skinItems) data.skinItems = [];
    const items = data.skinItems.slice().sort((a, b) => getSkinUrgency(b) - getSkinUrgency(a));

    // FAB visibility
    fabEl.style.display = currentView === 'day' ? '' : 'none';

    if (items.length === 0) {
      skinBody.innerHTML = '<div class="skin-empty">No skincare items yet. Tap + to add one.</div>';
      skinSummary.textContent = 'No items';
      return;
    }

    let html = '';
    let overdueCount = 0, dueSoonCount = 0, onTrackCount = 0;

    items.forEach(item => {
      const status = getSkinStatus(item);
      if (status === 'red') overdueCount++;
      else if (status === 'yellow') dueSoonCount++;
      else onTrackCount++;

      const lastCompletion = item.completions && item.completions.length > 0
        ? item.completions[item.completions.length - 1] : null;
      const metaText = (lastCompletion ? 'Last: ' + formatTimeAgo(lastCompletion) : 'Never done') +
        ' \u00b7 ' + formatInterval(item.intervalDays);
      const isExpanded = expandedSkinItem === item.id;

      html += '<div class="skin-item" data-skin-id="' + item.id + '">';
      html += '<div class="skin-status-dot ' + status + '"></div>';
      html += '<div class="skin-item-info">';
      html += '<div class="skin-item-name">' + escapeHtml(item.name) + '</div>';
      html += '<div class="skin-item-meta">' + metaText + '</div>';
      html += '</div>';
      html += '<button class="skin-done-btn" data-skin-done="' + item.id + '">Done</button>';
      html += '</div>';

      if (isExpanded) {
        html += '<div class="skin-item-detail" data-skin-detail="' + item.id + '">';
        html += '<div class="skin-detail-row">Frequency: ' + formatInterval(item.intervalDays) + '</div>';
        html += '<div class="skin-detail-row">Completions: ' + (item.completions ? item.completions.length : 0) + '</div>';
        html += '<div class="skin-detail-actions">';
        html += '<button data-skin-edit="' + item.id + '">Edit</button>';
        html += '<button class="delete" data-skin-delete="' + item.id + '">Delete</button>';
        html += '</div>';
        html += '</div>';
      }
    });

    skinBody.innerHTML = html;

    const parts = [];
    if (overdueCount > 0) parts.push(overdueCount + ' overdue');
    if (dueSoonCount > 0) parts.push(dueSoonCount + ' due soon');
    if (onTrackCount > 0) parts.push(onTrackCount + ' on track');
    skinSummary.textContent = parts.join(' \u00b7 ');

    // Wire events
    skinBody.querySelectorAll('.skin-item').forEach(el => {
      el.addEventListener('click', e => {
        if (e.target.closest('.skin-done-btn')) return;
        const id = el.dataset.skinId;
        expandedSkinItem = expandedSkinItem === id ? null : id;
        renderSkin();
      });
    });

    skinBody.querySelectorAll('.skin-done-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = btn.dataset.skinDone;
        const item = data.skinItems.find(i => i.id === id);
        if (!item) return;
        if (!item.completions) item.completions = [];
        const ts = new Date().toISOString();
        item.completions.push(ts);
        save();
        showToast(item.name + ' done! <span style="text-decoration:underline;cursor:pointer" id="undo-skin">Undo</span>');
        renderSkin();

        // Undo
        if (undoTimer) clearTimeout(undoTimer);
        undoTimer = setTimeout(() => {
          const undoEl = document.getElementById('undo-skin');
          if (undoEl) undoEl.remove();
        }, 4000);

        setTimeout(() => {
          const undoEl = document.getElementById('undo-skin');
          if (undoEl) {
            undoEl.addEventListener('click', () => {
              const idx = item.completions.indexOf(ts);
              if (idx > -1) item.completions.splice(idx, 1);
              save();
              showToast('Undone');
              renderSkin();
            });
          }
        }, 50);
      });
    });

    skinBody.querySelectorAll('[data-skin-edit]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        openSkinModal(btn.dataset.skinEdit);
      });
    });

    skinBody.querySelectorAll('[data-skin-delete]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = btn.dataset.skinDelete;
        const item = data.skinItems.find(i => i.id === id);
        if (confirm('Delete "' + item.name + '"?')) {
          data.skinItems = data.skinItems.filter(i => i.id !== id);
          expandedSkinItem = null;
          save();
          showToast('Deleted');
          renderSkin();
        }
      });
    });
  }

  // --- Skin modal ---
  function openSkinModal(editId) {
    editingSkinItem = editId || null;
    if (editId) {
      const item = data.skinItems.find(i => i.id === editId);
      skinModalTitle.textContent = 'Edit Skin Item';
      skinNameInput.value = item.name;
      // Reverse-engineer frequency
      if (item.intervalDays % 30 === 0 && item.intervalDays >= 30) {
        skinFreqNum.value = item.intervalDays / 30;
        skinFreqUnit.value = 'months';
      } else if (item.intervalDays % 7 === 0 && item.intervalDays >= 7) {
        skinFreqNum.value = item.intervalDays / 7;
        skinFreqUnit.value = 'weeks';
      } else {
        skinFreqNum.value = item.intervalDays;
        skinFreqUnit.value = 'days';
      }
    } else {
      skinModalTitle.textContent = 'Add Skin Item';
      skinNameInput.value = '';
      skinFreqNum.value = 1;
      skinFreqUnit.value = 'weeks';
    }
    skinOverlay.classList.add('open');
    setTimeout(() => skinNameInput.focus(), 100);
  }

  function closeSkinModal() {
    skinOverlay.classList.remove('open');
    editingSkinItem = null;
  }

  function saveSkinItem() {
    const name = skinNameInput.value.trim();
    if (!name) return;
    const num = parseInt(skinFreqNum.value) || 1;
    const unit = skinFreqUnit.value;
    const intervalDays = unit === 'months' ? num * 30 : unit === 'weeks' ? num * 7 : num;

    if (editingSkinItem) {
      const item = data.skinItems.find(i => i.id === editingSkinItem);
      if (item) {
        item.name = name;
        item.intervalDays = intervalDays;
      }
      showToast('Updated');
    } else {
      if (!data.skinItems) data.skinItems = [];
      data.skinItems.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        name,
        intervalDays,
        createdAt: new Date().toISOString(),
        completions: []
      });
      showToast(name + ' added');
    }
    save();
    closeSkinModal();
    expandedSkinItem = null;
    renderSkin();
  }

  // FAB
  fabEl.addEventListener('click', () => openSkinModal(null));

  // Skin modal events
  skinOverlay.addEventListener('click', e => { if (e.target === skinOverlay) closeSkinModal(); });
  document.getElementById('skin-cancel').addEventListener('click', closeSkinModal);
  document.getElementById('skin-save').addEventListener('click', saveSkinItem);

  // --- Summary views ---
  function getDaysInRange(startDate, endDate) {
    const days = [];
    const d = new Date(startDate);
    const end = new Date(endDate);
    while (d <= end) {
      days.push(dateKey(d));
      d.setDate(d.getDate() + 1);
    }
    return days;
  }

  function getSummaryRange() {
    const today = new Date();
    if (currentView === 'week') {
      const week = getWeekRange(currentDate);
      // Cap end at today
      const end = week.end > today ? today : week.end;
      return getDaysInRange(week.start, end);
    } else {
      const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      const end = lastDay > today ? today : lastDay;
      return getDaysInRange(start, end);
    }
  }

  function renderSummary() {
    const dayKeys = getSummaryRange();
    const totalDays = dayKeys.length;
    const periodLabel = currentView === 'week' ? '7' : totalDays;

    let html = '';

    // --- Weight summary ---
    const weights = dayKeys.filter(dk => data.days[dk] && data.days[dk].weight != null)
      .map(dk => ({ date: dk, weight: data.days[dk].weight }));

    html += '<div class="summary-card">';
    html += '<p class="summary-card-title">Weight</p>';
    if (weights.length > 0) {
      const first = weights[0].weight;
      const last = weights[weights.length - 1].weight;
      const diff = last - first;
      const min = Math.min(...weights.map(w => w.weight));
      const max = Math.max(...weights.map(w => w.weight));
      const avg = (weights.reduce((s, w) => s + w.weight, 0) / weights.length).toFixed(1);
      const diffClass = diff < -0.05 ? 'green' : diff > 0.05 ? 'red' : 'neutral';
      const diffStr = (diff > 0 ? '+' : '') + diff.toFixed(1);

      html += '<div class="stat-grid">';
      html += '<div class="stat-box"><div class="stat-box-value">' + avg + '</div><div class="stat-box-label">Average (lbs)</div></div>';
      html += '<div class="stat-box"><div class="stat-box-value ' + diffClass + '">' + diffStr + '</div><div class="stat-box-label">Change (lbs)</div></div>';
      html += '<div class="stat-box"><div class="stat-box-value">' + min + '</div><div class="stat-box-label">Low</div></div>';
      html += '<div class="stat-box"><div class="stat-box-value">' + max + '</div><div class="stat-box-label">High</div></div>';
      html += '</div>';

      // Mini chart
      if (weights.length > 1) {
        const range = max - min || 1;
        html += '<div class="weight-mini-row">';
        dayKeys.forEach(dk => {
          const w = data.days[dk] && data.days[dk].weight;
          const d = new Date(dk + 'T12:00:00');
          const dayLabel = d.toLocaleDateString(undefined, { weekday: 'narrow' });
          const pct = w != null ? Math.max(10, ((w - min) / range) * 100) : 0;
          html += '<div class="weight-mini-col">';
          html += '<div style="height:60px;display:flex;align-items:flex-end;width:100%">';
          html += '<div class="weight-mini-bar' + (w != null ? ' has-data' : '') + '" style="height:' + (w != null ? pct : 5) + '%;width:100%"></div>';
          html += '</div>';
          html += '<div class="weight-mini-label">' + dayLabel + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }
    } else {
      html += '<div class="stat-box" style="text-align:center;"><div class="stat-box-label">No weight data logged</div></div>';
    }
    html += '</div>';

    // --- Exercise summary ---
    html += '<div class="summary-card">';
    html += '<p class="summary-card-title">Exercise</p>';

    let totalActiveDays = 0;
    dayKeys.forEach(dk => {
      if (data.days[dk]) {
        const ex = data.days[dk].exercises || {};
        if (Object.values(ex).some(e => e && e.done)) totalActiveDays++;
      }
    });

    html += '<div class="stat-grid" style="margin-bottom:12px">';
    html += '<div class="stat-box"><div class="stat-box-value">' + totalActiveDays + '</div><div class="stat-box-label">Active Days</div><div class="stat-box-sub">out of ' + totalDays + '</div></div>';
    const pct = totalDays > 0 ? Math.round(totalActiveDays / totalDays * 100) : 0;
    html += '<div class="stat-box"><div class="stat-box-value">' + pct + '%</div><div class="stat-box-label">Consistency</div></div>';
    html += '</div>';

    EXERCISES.forEach(ex => {
      let count = 0;
      dayKeys.forEach(dk => {
        if (data.days[dk] && data.days[dk].exercises && data.days[dk].exercises[ex.key] && data.days[dk].exercises[ex.key].done) count++;
      });
      const barPct = totalDays > 0 ? (count / totalDays * 100) : 0;
      html += '<div class="exercise-stat-row">';
      html += '<span class="exercise-stat-name">' + ex.label + '</span>';
      html += '<div class="exercise-stat-bar"><div class="exercise-stat-fill" style="width:' + barPct + '%"></div></div>';
      html += '<span class="exercise-stat-count">' + count + '/' + totalDays + '</span>';
      html += '</div>';
    });
    html += '</div>';

    // --- Nutrition summary ---
    html += '<div class="summary-card">';
    html += '<p class="summary-card-title">Nutrition</p>';

    // Vitamins & Drinks
    let vitCount = 0;
    let totalDrinks = 0;
    dayKeys.forEach(dk => {
      if (data.days[dk]) {
        if (data.days[dk].vitamins) vitCount++;
        if (data.days[dk].drinks) totalDrinks += data.days[dk].drinks;
      }
    });

    const avgDrinks = totalDays > 0 ? (totalDrinks / totalDays).toFixed(1) : '0';

    html += '<div class="stat-grid" style="margin-bottom:12px">';
    html += '<div class="stat-box"><div class="stat-box-value">' + vitCount + '/' + totalDays + '</div><div class="stat-box-label">Vitamins Taken</div></div>';
    html += '<div class="stat-box"><div class="stat-box-value">' + totalDrinks + '</div><div class="stat-box-label">Total Drinks</div><div class="stat-box-sub">' + avgDrinks + '/day avg</div></div>';
    html += '</div>';

    // Meal ratings breakdown
    let greenCount = 0, yellowCount = 0, redCount = 0, totalMeals = 0;
    dayKeys.forEach(dk => {
      if (data.days[dk] && data.days[dk].meals) {
        Object.values(data.days[dk].meals).forEach(meal => {
          if (meal && meal.rating) {
            totalMeals++;
            if (meal.rating === 'green') greenCount++;
            else if (meal.rating === 'yellow') yellowCount++;
            else if (meal.rating === 'red') redCount++;
          }
        });
      }
    });

    if (totalMeals > 0) {
      html += '<p style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Meal Ratings</p>';
      [
        { label: 'Healthy', cls: 'green', count: greenCount },
        { label: 'Okay', cls: 'yellow', count: yellowCount },
        { label: 'Unhealthy', cls: 'red', count: redCount }
      ].forEach(r => {
        const pct = (r.count / totalMeals * 100);
        html += '<div class="rating-summary-row">';
        html += '<div class="rating-summary-dot" style="background:var(--' + r.cls + ')"></div>';
        html += '<span class="rating-summary-label">' + r.label + '</span>';
        html += '<div class="rating-summary-bar"><div class="rating-summary-fill ' + r.cls + '" style="width:' + pct + '%"></div></div>';
        html += '<span class="rating-summary-count">' + r.count + '</span>';
        html += '</div>';
      });
    } else {
      html += '<div class="stat-box" style="text-align:center"><div class="stat-box-label">No meals rated yet</div></div>';
    }

    html += '</div>';

    // --- Skin summary ---
    if (data.skinItems && data.skinItems.length > 0) {
      html += '<div class="summary-card">';
      html += '<p class="summary-card-title">Skin</p>';

      // Count completions in range
      const rangeStart = new Date(dayKeys[0] + 'T00:00:00').getTime();
      const rangeEnd = new Date(dayKeys[dayKeys.length - 1] + 'T23:59:59').getTime();
      let totalCompletions = 0;

      data.skinItems.forEach(item => {
        let count = 0;
        (item.completions || []).forEach(c => {
          const t = new Date(c).getTime();
          if (t >= rangeStart && t <= rangeEnd) count++;
        });
        totalCompletions += count;

        const status = getSkinStatus(item);
        const lastC = item.completions && item.completions.length > 0 ? item.completions[item.completions.length - 1] : null;
        html += '<div class="exercise-stat-row">';
        html += '<div class="skin-status-dot ' + status + '" style="flex-shrink:0"></div>';
        html += '<span class="exercise-stat-name">' + escapeHtml(item.name) + '</span>';
        html += '<span class="exercise-stat-count">' + count + '</span>';
        html += '</div>';
      });

      html += '<div style="text-align:center;margin-top:8px;font-size:12px;color:var(--text-secondary)">' + totalCompletions + ' total completions this ' + (currentView === 'week' ? 'week' : 'month') + '</div>';
      html += '</div>';
    }

    summaryContent.innerHTML = html;
  }

  function getWeeklyDrinks() {
    let total = 0;
    const today = new Date();
    for (let i = 0; i < 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dk = dateKey(d);
      if (data.days[dk] && data.days[dk].drinks) total += data.days[dk].drinks;
    }
    return total;
  }

  // --- Meal modal ---
  function openMealModal(mealKey, dk) {
    editingMeal = { key: mealKey, dk };
    const day = getDay(dk);
    const meal = day.meals[mealKey];

    modalTitle.textContent = 'Log ' + MEAL_LABELS[mealKey];
    mealInput.value = meal.summary || '';
    selectedRating = meal.rating || null;
    updateRatingUI();

    // Show clear button if meal has data
    const hasClear = meal.summary || meal.rating;
    let actionsHtml = '<button class="btn-cancel" id="meal-cancel">Cancel</button>';
    if (hasClear) actionsHtml += '<button class="btn-clear" id="meal-clear">Clear</button>';
    actionsHtml += '<button class="btn-save" id="meal-save">Save</button>';
    modalActions.innerHTML = actionsHtml;

    // Re-wire buttons
    document.getElementById('meal-cancel').addEventListener('click', closeModal);
    document.getElementById('meal-save').addEventListener('click', saveMeal);
    const clearBtn = document.getElementById('meal-clear');
    if (clearBtn) clearBtn.addEventListener('click', clearMeal);

    overlayEl.classList.add('open');
    setTimeout(() => mealInput.focus(), 100);
  }

  function saveMeal() {
    if (!editingMeal) return;
    const day = getDay(editingMeal.dk);
    day.meals[editingMeal.key] = { summary: mealInput.value.trim(), rating: selectedRating };
    save();
    showToast(MEAL_LABELS[editingMeal.key] + ' saved');
    closeModal();
    render();
  }

  function clearMeal() {
    if (!editingMeal) return;
    const day = getDay(editingMeal.dk);
    day.meals[editingMeal.key] = { summary: '', rating: null };
    save();
    showToast(MEAL_LABELS[editingMeal.key] + ' cleared');
    closeModal();
    render();
  }

  function closeModal() {
    overlayEl.classList.remove('open');
    editingMeal = null;
  }

  overlayEl.addEventListener('click', e => { if (e.target === overlayEl) closeModal(); });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (skinOverlay.classList.contains('open')) closeSkinModal();
      else if (overlayEl.classList.contains('open')) closeModal();
    }
  });

  // Rating picker
  ratingPicker.addEventListener('click', e => {
    const opt = e.target.closest('.rating-option');
    if (!opt) return;
    const r = opt.dataset.rating;
    selectedRating = selectedRating === r ? null : r;
    updateRatingUI();
  });

  function updateRatingUI() {
    ratingPicker.querySelectorAll('.rating-option').forEach(opt => {
      opt.classList.remove('selected', 'none-selected');
      if (selectedRating === null) {
        opt.classList.add('none-selected');
      } else if (opt.dataset.rating === selectedRating) {
        opt.classList.add('selected');
      }
    });
  }

  // --- Toast ---
  let toastTimer = null;
  function showToast(msg) {
    if (toastTimer) clearTimeout(toastTimer);
    toastEl.innerHTML = msg;
    toastEl.classList.add('visible');
    toastTimer = setTimeout(() => toastEl.classList.remove('visible'), 4000);
  }

  // --- Helpers ---
  function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function escapeAttr(s) {
    return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // --- Init ---
  loadLocal();
  render();
  syncFromCloud();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
})();
</script>
</body>
</html>
